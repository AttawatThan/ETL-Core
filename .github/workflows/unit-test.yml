name: ETL Core Unit Tests

on:
  push:
    branches:
      - main
      - feature/**
  pull_request:
    branches:
      - main

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/attawatthan/airflow:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      # Require: This must be here for actions/checkout to work
      options: --user root
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup and Run Tests
        run: |
          # Create symlink in parent directory so etl_core imports work
          CURRENT_DIR=$(pwd)
          PARENT_DIR=$(dirname "$CURRENT_DIR")
          
          cd "$PARENT_DIR"
          ln -s ETL-Core etl_core
          cd ETL-Core
          
          # Change ownership
          chown -R airflow:root .
          
          echo "Current directory: $(pwd)"
          echo "Symlink created:"
          ls -la "$PARENT_DIR" | grep etl_core
          
          # Install dependencies and run tests as airflow user
          su airflow << 'EOF'
            export PATH=$PATH:/home/airflow/.local/bin
            
            echo "Installing test dependencies..."
            pip install pytest pytest-cov
            
            echo "current path: $(pwd)"
            
            # Set PYTHONPATH to parent directory so etl_core module can be imported
            export PYTHONPATH=$PYTHONPATH:$(dirname $(pwd))
            echo "PYTHONPATH: $PYTHONPATH"

            echo "Running unit tests..."
            pytest tests/ -v
          EOF
