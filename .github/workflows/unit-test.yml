name: ETL Core Unit Tests

on:
  push:
    branches:
      - main
      - feature/**

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/attawatthan/airflow:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      # Require: This must be here for actions/checkout to work
      options: --user root
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Dependencies and Run Tests
        run: |
          su airflow << 'EOF'
            # A. Add the user's local bin to PATH (where pip installs things)
            export PATH=$PATH:/home/airflow/.local/bin
            
            # B. Install testing tools (as airflow user)
            echo "Installing dependencies..."
            pip install pytest pytest-cov
            
            # C. Set PYTHONPATH so tests can find your code
            export PYTHONPATH=$PYTHONPATH:.
            
            # D. Run the tests
            echo "Running tests..."
            pytest tests/ -v
          EOF
