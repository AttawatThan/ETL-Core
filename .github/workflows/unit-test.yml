name: ETL Core Unit Tests

on:
  push:
    branches:
      - main
      - feature/**
  pull_request:
    branches:
      - main

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/attawatthan/airflow:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      # Require: This must be here for actions/checkout to work
      options: --user root
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Fix Permission issues
      - name: Transfer ownership to airflow user
        run: chown -R airflow:root .

      - name: Install Dependencies
        run: |
          su airflow << 'EOF'
            export PATH=$PATH:/home/airflow/.local/bin

            echo "Installing test dependencies..."
            pip install pytest pytest-cov
          EOF

      - name: Run Unit Tests
        run: |
          su airflow << 'EOF'
            # Set PATH for airflow user
            export PATH=$PATH:/home/airflow/.local/bin
            
            # Get the current workspace directory
            WORKSPACE_DIR=$(pwd)
            PARENT_DIR=$(dirname "$WORKSPACE_DIR")
            
            # Set PYTHONPATH to include the parent directory
            export PYTHONPATH=$PYTHONPATH:$PARENT_DIR

            # Create a symbolic link in the parent directory if it doesn't exist
            cd "$PARENT_DIR"
            if [ ! -L "etl_core" ] && [ ! -d "etl_core" ]; then
              ln -s "$WORKSPACE_DIR" etl_core
            fi

            cd "$WORKSPACE_DIR"
            echo "Running unit tests..."
            pytest tests/ -v
          EOF
